#####################################################################
# spoolman_qidi_box1.cfg
#
# Maintainer: Ivantify
# Purpose: QIDI Box1 slot-based Spoolman tracking
######################################################################

# Slot selector macros (these show up in Fluidd Spoolman "Change Spool")
[gcode_macro BOX1_SLOT1]
variable_spool_id: None
gcode:

[gcode_macro BOX1_SLOT2]
variable_spool_id: None
gcode:

[gcode_macro BOX1_SLOT3]
variable_spool_id: None
gcode:

[gcode_macro BOX1_SLOT4]
variable_spool_id: None
gcode:

# Restore only slot selectors
[gcode_macro RESTORE_TOOL_SPOOLS_BOX1]
description: Restore Box1 SLOT selectors (BOX1_SLOT1..4) from Fluidd-saved variables
gcode:
  {% set svv = printer.save_variables.variables %}

  {% for m in ['BOX1_SLOT1','BOX1_SLOT2','BOX1_SLOT3','BOX1_SLOT4'] %}
    {% set key = (m + '__SPOOL_ID')|lower %}
    {% set sid = svv[key]|default(0)|int %}
    {% if sid > 0 %}
      SET_GCODE_VARIABLE MACRO={m} VARIABLE=spool_id VALUE={sid}
    {% else %}
      SET_GCODE_VARIABLE MACRO={m} VARIABLE=spool_id VALUE=None
    {% endif %}
  {% endfor %}

  RESPOND TYPE=echo MSG="Restored Box1 slot->spool mapping (BOX1_SLOT1..4)."

[delayed_gcode RESTORE_SELECTED_SPOOLS]
initial_duration: 1
gcode:
  RESTORE_TOOL_SPOOLS_BOX1

# Debug helpers
[gcode_macro REPORT_BOX1_TOOL_SLOT_MAP]
gcode:
  {% set sv = printer.save_variables.variables %}
  RESPOND TYPE=echo MSG="Box1 tool->slot: T0={sv.value_t0|default('unset')}, T1={sv.value_t1|default('unset')}, T2={sv.value_t2|default('unset')}, T3={sv.value_t3|default('unset')}"

[gcode_macro CHEATSHEET_BOX1]
gcode:
  {% set sv = printer.save_variables.variables %}
  RESPOND TYPE=echo MSG="Slot1(raw slot0) spool_id={printer['gcode_macro BOX1_SLOT1'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot2(raw slot1) spool_id={printer['gcode_macro BOX1_SLOT2'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot3(raw slot2) spool_id={printer['gcode_macro BOX1_SLOT3'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot4(raw slot3) spool_id={printer['gcode_macro BOX1_SLOT4'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Tool->slot now: T0={sv.value_t0|default('unset')}, T1={sv.value_t1|default('unset')}, T2={sv.value_t2|default('unset')}, T3={sv.value_t3|default('unset')}"

# Tool macros (override vendor T0..T3; box.cfg must be included first)
# Behavior:
# 1) Determine which slot QIDI says this tool maps to (value_tN)
# 2) Set active spool from the corresponding BOX1_SLOT macro
# 3) Call EXTRUDER_LOAD only if slot is valid
[gcode_macro T0]
gcode:
  {% set slot = printer.save_variables.variables.value_t0|default('slot0') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX1_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX1_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX1_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX1_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T1]
gcode:
  {% set slot = printer.save_variables.variables.value_t1|default('slot1') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX1_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX1_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX1_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX1_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T2]
gcode:
  {% set slot = printer.save_variables.variables.value_t2|default('slot2') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX1_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX1_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX1_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX1_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T3]
gcode:
  {% set slot = printer.save_variables.variables.value_t3|default('slot3') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX1_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX1_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX1_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX1_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}
