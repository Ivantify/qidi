#####################################################################
# spoolman_qidi_box2.cfg
#
# Maintainer: Ivantify
# Purpose: QIDI Box slot-based Spoolman tracking
######################################################################

# Slot selector macros (these show up in Fluidd Spoolman "Change Spool")
[gcode_macro BOX2_SLOT1]
variable_spool_id: None
gcode:

[gcode_macro BOX2_SLOT2]
variable_spool_id: None
gcode:

[gcode_macro BOX2_SLOT3]
variable_spool_id: None
gcode:

[gcode_macro BOX2_SLOT4]
variable_spool_id: None
gcode:

# Restore only slot selectors
[gcode_macro RESTORE_TOOL_SPOOLS_BOX2]
description: Restore Box2 SLOT selectors (BOX2_SLOT1..4) from Fluidd-saved variables
gcode:
  {% set svv = printer.save_variables.variables %}

  {% for m in ['BOX2_SLOT1','BOX2_SLOT2','BOX2_SLOT3','BOX2_SLOT4'] %}
    {% set key = (m + '__SPOOL_ID')|lower %}
    {% set sid = svv[key]|default(0)|int %}
    {% if sid > 0 %}
      SET_GCODE_VARIABLE MACRO={m} VARIABLE=spool_id VALUE={sid}
    {% else %}
      SET_GCODE_VARIABLE MACRO={m} VARIABLE=spool_id VALUE=None
    {% endif %}
  {% endfor %}

  RESPOND TYPE=echo MSG="Restored Box2 slot->spool mapping (BOX2_SLOT1..4)."

[delayed_gcode RESTORE_SELECTED_SPOOLS]
initial_duration: 1
gcode:
  RESTORE_TOOL_SPOOLS_BOX2

# Debug helpers
[gcode_macro REPORT_BOX2_TOOL_SLOT_MAP]
gcode:
  {% set sv = printer.save_variables.variables %}
  RESPOND TYPE=echo MSG="Box2 tool->slot: T4={sv.value_t4|default('unset')}, T5={sv.value_t5|default('unset')}, T6={sv.value_t6|default('unset')}, T7={sv.value_t7|default('unset')}"

[gcode_macro CHEATSHEET_BOX2]
gcode:
  {% set sv = printer.save_variables.variables %}
  RESPOND TYPE=echo MSG="Slot1(raw slot0) spool_id={printer['gcode_macro BOX2_SLOT1'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot2(raw slot1) spool_id={printer['gcode_macro BOX2_SLOT2'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot3(raw slot2) spool_id={printer['gcode_macro BOX2_SLOT3'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Slot4(raw slot3) spool_id={printer['gcode_macro BOX2_SLOT4'].spool_id|default(0)|int}"
  RESPOND TYPE=echo MSG="Tool->slot now: T4={sv.value_t4|default('unset')}, T5={sv.value_t5|default('unset')}, T6={sv.value_t6|default('unset')}, T7={sv.value_t7|default('unset')}"

# Tool macros (override vendor T4..T7; box.cfg must be included first)
# Behavior:
# 1) Determine which slot QIDI says this tool maps to (value_tN)
# 2) Set active spool from the corresponding BOX2_SLOT macro
# 3) Call EXTRUDER_LOAD only if slot is valid
[gcode_macro T4]
gcode:
  {% set slot = printer.save_variables.variables.value_t4|default('slot0') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX2_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX2_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX2_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX2_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T5]
gcode:
  {% set slot = printer.save_variables.variables.value_t5|default('slot1') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX2_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX2_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX2_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX2_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T6]
gcode:
  {% set slot = printer.save_variables.variables.value_t6|default('slot2') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX2_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX2_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX2_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX2_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}

[gcode_macro T7]
gcode:
  {% set slot = printer.save_variables.variables.value_t7|default('slot3') %}
  {% if slot == 'slot0' %}{% set sid = printer['gcode_macro BOX2_SLOT1'].spool_id %}
  {% elif slot == 'slot1' %}{% set sid = printer['gcode_macro BOX2_SLOT2'].spool_id %}
  {% elif slot == 'slot2' %}{% set sid = printer['gcode_macro BOX2_SLOT3'].spool_id %}
  {% elif slot == 'slot3' %}{% set sid = printer['gcode_macro BOX2_SLOT4'].spool_id %}
  {% else %}{% set sid = None %}
  {% endif %}

  {% if sid is not none and sid|int > 0 %}
    SET_ACTIVE_SPOOL ID={sid|int}
  {% else %}
    CLEAR_ACTIVE_SPOOL
  {% endif %}

  {% if slot in ['slot0','slot1','slot2','slot3'] and printer.save_variables.variables.enable_box == 1 %}
    EXTRUDER_LOAD SLOT={slot}
  {% endif %}
